name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ğŸ§ª Tests & Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ” Run TypeScript type checking
      run: npm run typecheck
      
    - name: ğŸ§¹ Run ESLint
      run: npm run lint
      
    - name: ğŸ§ª Run tests
      run: npm test -- --coverage --watchAll=false
      
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false
        
    - name: ğŸ’¾ Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

  build:
    name: ğŸ—ï¸ Build Check
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Test Expo build
      run: npx expo export --platform web --output-dir web-build
      
    - name: âœ… Build successful
      run: echo "âœ… Build completed successfully!"

  quality-gate:
    name: ğŸš¦ Quality Gate
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()
    
    steps:
    - name: ğŸ” Check job results
      run: |
        if [[ "${{ needs.test.result }}" != "success" ]]; then
          echo "âŒ ãƒ†ã‚¹ãƒˆã¾ãŸã¯ãƒªãƒ³ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          echo "âŒ Tests or linting failed. Please check the details above."
          exit 1
        fi
        
        if [[ "${{ needs.build.result }}" != "success" ]]; then
          echo "âŒ ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          echo "âŒ Build failed. Please check the details above."
          exit 1
        fi
        
        echo "âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸï¼ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™ã€‚"
        echo "âœ… All checks passed! Ready to merge."